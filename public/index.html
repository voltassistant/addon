<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° VoltAssistant Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white rounded-xl shadow-sm border border-gray-200 p-6; }
    .stat-value { @apply text-3xl font-bold; }
    .stat-label { @apply text-sm text-gray-500 mt-1; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-900">‚ö° VoltAssistant</h1>
      <p class="text-gray-600 mt-2">Panel de Control del Sistema Solar</p>
      <p id="timestamp" class="text-sm text-gray-400 mt-1"></p>
    </div>

    <!-- Health Banner -->
    <div id="health-banner" class="mb-6 rounded-xl p-4 hidden"></div>

    <!-- Main Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <!-- Battery -->
      <div class="card text-center">
        <div class="text-4xl mb-2">üîã</div>
        <div id="battery-soc" class="stat-value text-blue-600">--</div>
        <div class="stat-label">Bater√≠a</div>
        <div id="battery-state" class="text-xs text-gray-400 mt-1"></div>
      </div>

      <!-- Solar -->
      <div class="card text-center">
        <div class="text-4xl mb-2">‚òÄÔ∏è</div>
        <div id="solar-power" class="stat-value text-yellow-500">--</div>
        <div class="stat-label">Producci√≥n Solar</div>
        <div id="solar-today" class="text-xs text-gray-400 mt-1"></div>
      </div>

      <!-- Grid -->
      <div class="card text-center">
        <div class="text-4xl mb-2">üîå</div>
        <div id="grid-power" class="stat-value">--</div>
        <div class="stat-label">Red</div>
        <div id="grid-flow" class="text-xs mt-1"></div>
      </div>

      <!-- Load -->
      <div class="card text-center">
        <div class="text-4xl mb-2">üí°</div>
        <div id="load-power" class="stat-value text-purple-600">--</div>
        <div class="stat-label">Consumo</div>
        <div id="load-today" class="text-xs text-gray-400 mt-1"></div>
      </div>
    </div>

    <!-- Battery Detail -->
    <div class="card mb-6">
      <h2 class="text-xl font-semibold mb-4">üîã Estado de la Bater√≠a</h2>
      <div class="mb-4">
        <div class="flex justify-between text-sm mb-1">
          <span id="battery-kwh">-- kWh</span>
          <span id="battery-capacity">/ -- kWh</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6">
          <div id="battery-bar" class="h-6 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-4 text-center text-sm">
        <div>
          <div id="battery-power" class="font-bold">-- W</div>
          <div class="text-gray-500">Potencia</div>
        </div>
        <div>
          <div id="inverter-temp" class="font-bold">--¬∞C</div>
          <div class="text-gray-500">Temperatura</div>
        </div>
        <div>
          <div id="current-action" class="font-bold text-green-600">--</div>
          <div class="text-gray-500">Acci√≥n</div>
        </div>
      </div>
    </div>

    <!-- Recommendations -->
    <div class="card mb-6">
      <h2 class="text-xl font-semibold mb-4">üí° Recomendaciones</h2>
      <ul id="recommendations" class="space-y-2">
        <li class="text-gray-500">Cargando...</li>
      </ul>
    </div>

    <!-- Price Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Current Price -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-4">üí∂ Precio Actual</h2>
        <div class="text-center">
          <div id="current-price" class="text-4xl font-bold text-gray-900">--</div>
          <div class="text-sm text-gray-500">‚Ç¨/kWh</div>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-4 text-center text-sm">
          <div>
            <div id="avg-price" class="font-bold">--</div>
            <div class="text-gray-500">Media</div>
          </div>
          <div>
            <div id="savings" class="font-bold text-green-600">--</div>
            <div class="text-gray-500">Ahorro Est.</div>
          </div>
        </div>
      </div>

      <!-- Hours -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-4">‚è∞ Horas √ìptimas</h2>
        <div class="space-y-3">
          <div>
            <span class="text-green-600 font-medium">üü¢ Baratas:</span>
            <span id="cheap-hours" class="ml-2">--</span>
          </div>
          <div>
            <span class="text-red-600 font-medium">üî¥ Caras:</span>
            <span id="expensive-hours" class="ml-2">--</span>
          </div>
          <div>
            <span class="text-blue-600 font-medium">üîå Cargar:</span>
            <span id="charge-hours" class="ml-2">--</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Solar Forecast -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-4">‚òÄÔ∏è Previsi√≥n Solar</h2>
      <div class="grid grid-cols-2 gap-4 text-center">
        <div>
          <div id="solar-forecast" class="text-3xl font-bold text-yellow-500">--</div>
          <div class="text-sm text-gray-500">kWh esperados hoy</div>
        </div>
        <div>
          <div id="solar-peak" class="text-3xl font-bold text-orange-500">--</div>
          <div class="text-sm text-gray-500">Pico a las --:00</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-8 text-sm text-gray-400">
      <p>VoltAssistant v1.0 | Actualizaci√≥n cada 30 segundos</p>
      <p class="mt-1">
        <a href="/health" class="text-blue-500 hover:underline">API Health</a> |
        <a href="/dashboard" class="text-blue-500 hover:underline">JSON Data</a>
      </p>
    </div>
  </div>

  <script>
    async function updateDashboard() {
      try {
        const response = await fetch('/dashboard');
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        const { realtime, plan, prices, solar } = data;
        
        // Timestamp
        document.getElementById('timestamp').textContent = 
          `√öltima actualizaci√≥n: ${new Date(data.timestamp).toLocaleTimeString('es-ES')}`;
        
        // Battery
        document.getElementById('battery-soc').textContent = `${realtime.battery.soc}%`;
        document.getElementById('battery-state').textContent = 
          realtime.battery.state === 'charging' ? '‚¨ÜÔ∏è Cargando' :
          realtime.battery.state === 'discharging' ? '‚¨áÔ∏è Descargando' : '‚û°Ô∏è Idle';
        document.getElementById('battery-kwh').textContent = `${realtime.battery.kwh} kWh`;
        document.getElementById('battery-capacity').textContent = `/ ${realtime.battery.capacity} kWh`;
        document.getElementById('battery-power').textContent = `${realtime.battery.power} W`;
        
        const batteryBar = document.getElementById('battery-bar');
        batteryBar.style.width = `${realtime.battery.soc}%`;
        batteryBar.className = `h-6 rounded-full transition-all duration-500 ${
          realtime.battery.soc < 20 ? 'bg-red-500' :
          realtime.battery.soc < 50 ? 'bg-yellow-500' : 'bg-green-500'
        }`;
        
        // Solar
        document.getElementById('solar-power').textContent = `${(realtime.solar.totalPower / 1000).toFixed(1)} kW`;
        document.getElementById('solar-today').textContent = `Hoy: ${realtime.solar.todayKwh} kWh`;
        
        // Grid
        const gridPower = realtime.grid.power;
        document.getElementById('grid-power').textContent = `${Math.abs(gridPower)} W`;
        document.getElementById('grid-power').className = `stat-value ${gridPower > 0 ? 'text-red-500' : 'text-green-500'}`;
        document.getElementById('grid-flow').textContent = gridPower > 0 ? '‚¨ÖÔ∏è Importando' : '‚û°Ô∏è Exportando';
        document.getElementById('grid-flow').className = `text-xs mt-1 ${gridPower > 0 ? 'text-red-500' : 'text-green-500'}`;
        
        // Load
        document.getElementById('load-power').textContent = `${realtime.load.power} W`;
        document.getElementById('load-today').textContent = `Hoy: ${realtime.load.todayKwh} kWh`;
        
        // Temperature
        document.getElementById('inverter-temp').textContent = `${realtime.temperature.inverter}¬∞C`;
        
        // Current Action
        const actionMap = {
          'charge_from_grid': 'üîå Carga Red',
          'charge_from_solar': '‚òÄÔ∏è Carga Solar',
          'discharge': 'üîã Descarga',
          'idle': '‚è∏Ô∏è Espera'
        };
        document.getElementById('current-action').textContent = actionMap[plan.currentAction] || plan.currentAction;
        
        // Recommendations
        const recList = document.getElementById('recommendations');
        recList.innerHTML = plan.recommendations.map(r => `<li>${r}</li>`).join('');
        
        // Prices
        document.getElementById('current-price').textContent = (prices.current * 100).toFixed(2) + '¬¢';
        document.getElementById('avg-price').textContent = (prices.average * 100).toFixed(2) + '¬¢/kWh';
        document.getElementById('savings').textContent = `‚Ç¨${plan.estimatedSavings.toFixed(2)}`;
        
        // Hours
        document.getElementById('cheap-hours').textContent = prices.cheapestHours.map(h => `${h}:00`).join(', ');
        document.getElementById('expensive-hours').textContent = prices.expensiveHours.map(h => `${h}:00`).join(', ');
        document.getElementById('charge-hours').textContent = plan.gridChargeHours.map(h => `${h}:00`).join(', ') || 'Ninguna';
        
        // Solar Forecast
        document.getElementById('solar-forecast').textContent = (solar.forecast / 1000).toFixed(1);
        document.getElementById('solar-peak').textContent = `${solar.peak.watts} W`;
        document.getElementById('solar-peak').nextElementSibling.textContent = `Pico a las ${solar.peak.hour}:00`;
        
        // Health
        const banner = document.getElementById('health-banner');
        if (realtime.health.issues.length > 0) {
          banner.className = `mb-6 rounded-xl p-4 ${
            realtime.health.status === 'error' ? 'bg-red-100 border border-red-300' : 'bg-yellow-100 border border-yellow-300'
          }`;
          banner.innerHTML = `<strong>‚ö†Ô∏è Alertas:</strong> ${realtime.health.issues.join(' | ')}`;
          banner.classList.remove('hidden');
        } else {
          banner.classList.add('hidden');
        }
        
      } catch (error) {
        console.error('Error updating dashboard:', error);
      }
    }
    
    // Initial load
    updateDashboard();
    
    // Auto-refresh every 30 seconds
    setInterval(updateDashboard, 30000);
  </script>
</body>
</html>
